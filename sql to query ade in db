CREATE OR ALTER PROCEDURE dbo.usp_EDA_Exact_Dependency_Report
AS
BEGIN
    SET NOCOUNT ON;

    /* ============================
       1. Exact metadata dependencies
       ============================ */
    SELECT
        'METADATA' AS Source,
        s.name AS SchemaName,
        o.name AS ObjectName,
        o.type_desc AS ObjectType,
        d.referenced_database_name AS ReferencedDatabase,
        d.referenced_schema_name,
        d.referenced_entity_name
    FROM sys.sql_expression_dependencies d
    JOIN sys.objects o
        ON d.referencing_id = o.object_id
    JOIN sys.schemas s
        ON o.schema_id = s.schema_id
    WHERE d.referenced_database_name = 'EDA'

    UNION ALL

    /* ============================
       2. Dynamic SQL â€“ exact patterns
       ============================ */
    SELECT
        'DYNAMIC_SQL' AS Source,
        s.name AS SchemaName,
        o.name AS ObjectName,
        o.type_desc AS ObjectType,
        'EDA' AS ReferencedDatabase,
        NULL,
        NULL
    FROM sys.sql_modules m
    JOIN sys.objects o ON m.object_id = o.object_id
    JOIN sys.schemas s ON o.schema_id = s.schema_id
    WHERE
        m.definition LIKE '%[[]EDA[]]%'
     OR m.definition LIKE '% FROM EDA.%'
     OR m.definition LIKE '% JOIN EDA.%'
     OR m.definition LIKE '% INTO EDA.%'
     OR m.definition LIKE '% UPDATE EDA.%';
END;
GO
     